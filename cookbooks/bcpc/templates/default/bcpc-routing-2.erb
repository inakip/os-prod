#!/bin/sh
################################################
#
#              Generated by Chef
#
################################################

# Add default routes as a safety net, then remove all at the end
ip route add <%=@node["bcpc"]["storage"]["cidr"]%> \
         dev <%=@node["bcpc"]["storage"]["interface"]%> \
         scope link src <%=@node["bcpc"]["storage"]["ip"]%> \
         table main
ip route add <%=@node["bcpc"]["floating"]["cidr"]%> \
         dev <%=@node["bcpc"]["floating"]["interface"]%> \
         scope link src <%=@node["bcpc"]["floating"]["ip"]%> \
         table main

# Build routing table for floating network
ip route flush table floating
ip route add default via <%=@node["bcpc"]["floating"]["gateway"]%> \
         dev <%=@node["bcpc"]["floating"]["interface"]%> \
         table floating
ip route add <%=@node["bcpc"]["floating"]["cidr"]%> \
         dev <%=@node["bcpc"]["floating"]["interface"]%> \
         scope link src <%=@node["bcpc"]["floating"]["ip"]%> \
         table floating

# Activate this routing table for floating traffic
ip rule del pref 10000
ip rule del pref 10001
ip rule add from <%=@node["bcpc"]["floating"]["cidr"]%> pref 10000 table floating
ip rule add to <%=@node["bcpc"]["floating"]["cidr"]%> pref 10001 table floating

# Build routing table for storage network
ip route flush table storage
ip route add default via <%=@node["bcpc"]["storage"]["gateway"]%> \
         dev <%=@node["bcpc"]["storage"]["interface"]%> \
         table storage 
ip route add <%=@node["bcpc"]["storage"]["cidr"]%> \
         dev <%=@node["bcpc"]["storage"]["interface"]%> \
         scope link src <%=@node["bcpc"]["storage"]["ip"]%> \
         table storage

# Activate this routing table for storage traffic
ip rule del pref 10002
ip rule del pref 10003
ip rule add from <%=@node["bcpc"]["storage"]["cidr"]%> pref 10002 table storage
ip rule add to <%=@node["bcpc"]["storage"]["cidr"]%> pref 10003 table storage

# Drop all routes to other networks from the main routing table
# XXX: The following line is intentionally duplicated to remove multiple default routes
ip route del default dev <%=@node["bcpc"]["floating"]["interface"]%> \
         table main
ip route del default dev <%=@node["bcpc"]["storage"]["interface"]%> \
         table main
ip route del <%=@node["bcpc"]["floating"]["cidr"]%> \
         dev <%=@node["bcpc"]["floating"]["interface"]%> \
         table main
ip route del <%=@node["bcpc"]["storage"]["cidr"]%> \
         dev <%=@node["bcpc"]["storage"]["interface"]%> \
         table main

# Flush the route cache to make sure these are active
ip route flush cache
